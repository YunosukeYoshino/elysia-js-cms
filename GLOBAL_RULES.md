# GLOBAL_RULES.md

このファイルは、本リポジトリにおけるAIエージェントおよび開発者のための包括的なガイドラインです。すべてのAIアシスタント（Claude, Gemini, ChatGPT, Windsurfなど）は、コードを生成・修正する前にこのファイルを参照してください。

## プロジェクト概要

ElysiaJS を使用した軽量な CMS API です。JWT 認証、ユーザー管理、投稿、カテゴリ、ファイルアップロード機能を提供し、Swagger UI によるAPI ドキュメントを備えています。Bun ランタイム、Prisma ORM、SQLite データベースを使用しています。

### 技術スタック
- **ランタイム**: Bun
- **フレームワーク**: ElysiaJS
- **ORM**: Prisma
- **データベース**: SQLite
- **言語**: TypeScript
- **ツール**: Biome (Lint/Format), Husky (Git Hooks)

## 基本コマンド

### 開発・ビルド
```bash
bun install                    # 依存関係のインストール
bun run dev                    # 開発サーバーの起動（自動リロード、ポート3001）
bun run start                  # 本番サーバーの起動
bun run build                  # プロジェクトをdist/にビルド
```

### データベース
```bash
bun prisma db push             # スキーマ変更をデータベースに反映
bun run seed                   # テストデータの投入
bun run prepare-db:test        # テストデータベースのリセット（テスト用）
```

### テスト・品質管理
```bash
bun test                       # 全テストの実行
bun test:coverage              # カバレッジレポート付きでテスト実行
bun run check                  # Biome リンターとフォーマッターのチェック
bun run lint:fix               # Biome による自動修正
```

## アーキテクチャと設計指針

### ドメイン駆動設計（DDD）
- **ドメイン中心**: ビジネスロジックを `src/domain` に集約する。
- **純粋なTypeScript**: ドメインモデルはフレームワークに依存しない純粋なクラスとして実装する。
- **リポジトリパターン**: データアクセスはリポジトリインターフェースを介して行う。

### フォルダ構造
- `src/domain/entities/` - ビジネスエンティティ（User, Post, Category）
- `src/routes/` - ドメイン別に分類されたAPI ルートハンドラ
- `src/middlewares/` - 共有ミドルウェア（認証など）
- `src/lib/` - データベース接続とユーティリティ
- `src/scripts/` - データベースシード・メンテナンススクリプト

### Elysia.js 特有のガイドライン
- **Context**: DDDのバウンデッドコンテキストとして扱う。
- **ハンドラ分離**: ドメインロジックはルートハンドラから分離する。
- **依存性注入**: テスト容易性を高めるためにDIパターンを活用する。

## コーディング規約

### 基本ルール
- **言語**: コードは英語、コメントとドキュメントは日本語。
- **ドキュメント**: パブリックなクラスやメソッドにはJSDoc（日本語）を記述する。
- **型定義**: 変数や関数の型（パラメータと戻り値）を必ず宣言する。

### 型安全性の厳格なルール（厳守）
- **`any` 型の使用は完全禁止**: どのような理由があっても `any` を使用しない。
- **`unknown` への無理やりなキャストは禁止**: `as unknown as SomeType` のような二重キャストは使用しない。
- **`biome-ignore` コメントは禁止**: lint エラーを無視せず、コードを修正して解決する。
- **`@ts-ignore` / `@ts-expect-error` は禁止**: TypeScript エラーを無視しない。

### 推奨される対処法
1. **適切な型定義を作成**: ライブラリの型が不足している場合は、型定義ファイル（`.d.ts`）を作成する。
2. **ジェネリクスを活用**: 汎用的な処理にはジェネリクスを使用する。
3. **Union型や交差型を活用**: 複数の型を扱う場合は適切に型を組み合わせる。

## AIエージェントのための自己修正ガイド（Vibe Coding）

AIがコードを生成・修正する際は、以下のステップを必ず実行してください。CIは非常に厳格です。

1. **コード生成後、必ず検証コマンドを実行する**
   - `bun run check`: Biomeのエラー（フォーマット、リント）を確認。
   - `bun test`: テストの通過を確認。

2. **Lintエラーと型エラーを解消する**
   - `biome-ignore` や `any` に逃げず、正しいコード修正と型定義を行う。
   - 未使用変数は `_` プレフィックスを付ける（例: `_unused`）。

3. **フォーマットを適用する**
   - 提出前に `bun run lint:fix` を実行して、コードスタイルを統一する。

4. **テスト駆動**
   - 新機能追加時はテストもセットで作成または更新する。
